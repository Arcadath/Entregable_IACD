<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso - Gestor de Inventario</title>
    <link rel="stylesheet" href="login.css">
</head>
<body>
    
    <div class="login-container">
        <div class="login-card">
            <h1 class="brand-title" id="form-title">Iniciar Sesión</h1>
            <p class="subtitle">Administra tu inventario fácilmente</p>
            
            <form id="email-form" class="auth-form">
                <div class="input-group">
                    <input type="email" id="email" placeholder="Correo electrónico" required>
                </div>
                <div class="input-group">
                    <input type="password" id="password" placeholder="Contraseña" required minlength="6">
                </div>
                
                <div id="error-msg" class="error-message" style="display: none;"></div>

                <button type="submit" id="submit-btn" class="btn-primary">Entrar</button>
            </form>

            <div class="divider">
                <span>o continúa con</span>
            </div>
            
            <button id="google-login-btn" class="google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G">
                Google
            </button>
            
            <div class="toggle-auth">
                <p id="toggle-text">¿No tienes cuenta? <a href="#" id="toggle-link">Regístrate aquí</a></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, provider } from './firebase-init.js';
        import { 
            signInWithPopup, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            updateProfile,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Elementos del DOM
        const form = document.getElementById('email-form');
        const emailInput = document.getElementById('email');
        const passInput = document.getElementById('password');
        const submitBtn = document.getElementById('submit-btn');
        const formTitle = document.getElementById('form-title');
        const errorMsg = document.getElementById('error-msg');
        const toggleLink = document.getElementById('toggle-link');
        const toggleText = document.getElementById('toggle-text');
        const googleBtn = document.getElementById('google-login-btn');

        // Estado: true = Login, false = Registro
        let isLoginMode = true;

        // 1. Verificar sesión activa
        onAuthStateChanged(auth, (user) => {
            if (user) window.location.href = "index.html";
        });

        // 2. Alternar entre Login y Registro
        toggleLink.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            errorMsg.style.display = 'none';
            form.reset();

            if (isLoginMode) {
                formTitle.textContent = "Iniciar Sesión";
                submitBtn.textContent = "Entrar";
                toggleText.innerHTML = '¿No tienes cuenta? <a href="#" id="toggle-link">Regístrate aquí</a>';
            } else {
                formTitle.textContent = "Crear Cuenta";
                submitBtn.textContent = "Registrarse";
                toggleText.innerHTML = '¿Ya tienes cuenta? <a href="#" id="toggle-link">Inicia sesión</a>';
            }
            // Re-asignar evento al nuevo link generado
            document.getElementById('toggle-link').addEventListener('click', toggleLink.click.bind(toggleLink));
        });

        // 3. Manejo del Formulario (Email/Pass)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const password = passInput.value;
            errorMsg.style.display = 'none';

            try {
                if (isLoginMode) {
                    // --- LOGIN ---
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    // --- REGISTRO ---
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    // Asignar un nombre por defecto (parte del correo antes del @)
                    await updateProfile(userCredential.user, {
                        displayName: email.split('@')[0]
                    });
                    // Recargar para que app.js detecte el displayName actualizado
                    window.location.href = "index.html";
                }
            } catch (error) {
                mostrarError(error.code);
            }
        });

        // 4. Manejo de Google
        googleBtn.addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                mostrarError(error.code);
            }
        });

        // Helper: Mensajes de error en español
        function mostrarError(code) {
            let mensaje = "Ocurrió un error inesperado.";
            switch(code) {
                case 'auth/invalid-email': mensaje = "El correo no es válido."; break;
                case 'auth/user-not-found': mensaje = "Usuario no encontrado."; break;
                case 'auth/wrong-password': mensaje = "Contraseña incorrecta."; break;
                case 'auth/email-already-in-use': mensaje = "Este correo ya está registrado."; break;
                case 'auth/weak-password': mensaje = "La contraseña debe tener al menos 6 caracteres."; break;
                case 'auth/popup-closed-by-user': mensaje = "Inicio de sesión cancelado."; break;
            }
            errorMsg.textContent = mensaje;
            errorMsg.style.display = 'block';
        }
    </script>
</body>
</html>